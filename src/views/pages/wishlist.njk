{% extends "layouts/base.njk" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    {# Page Header #}
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">My Wishlist</h1>
        <p class="text-gray-600">You have {{ wishlistItems.length }} item{% if wishlistItems.length != 1 %}s{% endif %} in your wishlist</p>
    </div>

    {% if wishlistItems and wishlistItems.length > 0 %}
    <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
        {% for item in wishlistItems %}
        <div class="bg-white rounded-lg shadow-md overflow-hidden group" data-wishlist-item="{{ item.id }}">
            {# Product Image #}
            <div class="relative aspect-w-1 aspect-h-1">
                <a href="/product/{{ item.product.slug }}" class="block">
                    <img 
                        src="{{ item.product.images[0].url | default('/static/images/placeholder.jpg') }}" 
                        alt="{{ item.product.name }}"
                        class="w-full h-64 object-cover group-hover:scale-105 transition-transform duration-300"
                        loading="lazy"
                    >
                </a>
                
                {# Remove from Wishlist Button #}
                <button 
                    onclick="removeFromWishlist('{{ item.id }}')"
                    class="absolute top-2 right-2 p-2 bg-white rounded-full shadow-md hover:bg-red-50 transition-colors duration-200"
                    aria-label="Remove from wishlist"
                >
                    <svg class="w-5 h-5 text-red-500" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                    </svg>
                </button>

                {# Sale Badge #}
                {% if item.product.discount %}
                <div class="absolute top-2 left-2 bg-red-600 text-white px-2 py-1 rounded text-xs font-bold">
                    {{ item.product.discount }}% OFF
                </div>
                {% endif %}
            </div>

            {# Product Details #}
            <div class="p-4">
                {# Brand #}
                {% if item.product.brand %}
                <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">{{ item.product.brand.name }}</p>
                {% endif %}

                {# Product Name #}
                <h3 class="font-semibold text-gray-900 mb-2">
                    <a href="/product/{{ item.product.slug }}" class="hover:text-primary-600 transition-colors">
                        {{ item.product.name }}
                    </a>
                </h3>

                {# Price #}
                <div class="mb-3">
                    {% if item.product.salePrice %}
                    <span class="text-lg font-bold text-gray-900">{{ item.product.salePrice | price }}</span>
                    <span class="text-sm text-gray-500 line-through ml-2">{{ item.product.price | price }}</span>
                    {% else %}
                    <span class="text-lg font-bold text-gray-900">{{ item.product.price | price }}</span>
                    {% endif %}
                </div>

                {# Stock Status #}
                {% if item.product.inStock %}
                <p class="text-sm text-green-600 mb-3">âœ“ In Stock</p>
                {% else %}
                <p class="text-sm text-red-600 mb-3">Out of Stock</p>
                {% endif %}

                {# Action Buttons #}
                <div class="flex gap-2">
                    {% if item.product.inStock %}
                    <button 
                        onclick="moveToCart('{{ item.product.slug }}', '{{ item.variantId }}')"
                        class="flex-1 px-4 py-2 bg-primary-600 text-white text-sm font-medium rounded-lg hover:bg-primary-700 transition-colors duration-200"
                    >
                        Move to Cart
                    </button>
                    {% else %}
                    <button 
                        disabled
                        class="flex-1 px-4 py-2 bg-gray-300 text-gray-500 text-sm font-medium rounded-lg cursor-not-allowed"
                    >
                        Out of Stock
                    </button>
                    {% endif %}
                    
                    <a 
                        href="/product/{{ item.product.slug }}"
                        class="px-4 py-2 border border-gray-300 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-50 transition-colors duration-200"
                    >
                        View
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {# Clear Wishlist Button #}
    <div class="mt-8 text-center">
        <button 
            onclick="clearWishlist()"
            class="px-6 py-2 border border-red-600 text-red-600 font-medium rounded-lg hover:bg-red-50 transition-colors duration-200"
        >
            Clear All Items
        </button>
    </div>

    {% else %}
    {# Empty Wishlist #}
    <div class="bg-white rounded-lg shadow-md p-12 text-center">
        <svg class="w-24 h-24 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
        </svg>
        <h2 class="text-2xl font-semibold text-gray-900 mb-2">Your wishlist is empty</h2>
        <p class="text-gray-600 mb-6">Save items you like to your wishlist and they'll appear here</p>
        <a 
            href="/products"
            class="inline-block px-6 py-3 bg-primary-600 text-white font-medium rounded-lg hover:bg-primary-700 transition-colors duration-200"
        >
            Start Shopping
        </a>
    </div>
    {% endif %}
</div>

<script>
async function removeFromWishlist(itemId) {
    if (!confirm('Are you sure you want to remove this item from your wishlist?')) return;
    
    try {
        const response = await fetch(`/wishlist/api/remove/${itemId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Remove item from DOM
            const itemElement = document.querySelector(`[data-wishlist-item="${itemId}"]`);
            if (itemElement) {
                itemElement.remove();
            }
            
            // Check if wishlist is now empty
            const remainingItems = document.querySelectorAll('[data-wishlist-item]');
            if (remainingItems.length === 0) {
                location.reload(); // Reload to show empty state
            }
        } else {
            alert('Error removing item: ' + result.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while removing the item');
    }
}

async function moveToCart(productSlug, variantId) {
    try {
        const response = await fetch('/cart/api/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                productSlug,
                variantId,
                quantity: 1
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Item added to cart!');
            // Optionally remove from wishlist after adding to cart
            // You could call removeFromWishlist here
        } else {
            alert('Error adding to cart: ' + result.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while adding to cart');
    }
}

async function clearWishlist() {
    if (!confirm('Are you sure you want to clear your entire wishlist?')) return;
    
    // Since we don't have a clear all endpoint, we'd need to remove each item
    // For now, we'll just reload the page after confirming
    const items = document.querySelectorAll('[data-wishlist-item]');
    for (const item of items) {
        const itemId = item.getAttribute('data-wishlist-item');
        await removeFromWishlist(itemId);
    }
}
</script>
{% endblock %}
